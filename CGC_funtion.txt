// ==================================================================================
// ä¿®æ”¹æœ¬åœ°çš„GPPæ•°æ®å’Œç³»æ•°
// ==================================================================================

// ç ”ç©¶åŒº
var ROI = createSimulatedROI();
var datapt = createSimulatedDataPoints();
var AOI = ee.Feature(ee.Geometry.Point([118.15, 33.85]), {label: 'Study_Area'});

// ============================= ç•Œé¢è®¾è®¡ =====================================
// åˆ›å»ºä¸»æ§åˆ¶é¢æ¿
var controlPanel = ui.Panel({
  layout: ui.Panel.Layout.flow('vertical'),
  style: {
    width: '350px',
    padding: '20px',
    backgroundColor: '#f8f9fa',
    border: '2px solid #dee2e6',
    borderRadius: '10px'
  }
});

// æ ‡é¢˜
var title = ui.Label({
  value: 'ğŸŒ¾ GPP-äº§é‡é¢„æµ‹åˆ†æå·¥å…·',
  style: {
    fontSize: '20px',
    fontWeight: 'bold',
    color: '#2d5a27',
    textAlign: 'center',
    margin: '0 0 20px 0'
  }
});

// å‚æ•°æ§åˆ¶åŒºåŸŸ
var parameterSection = ui.Panel({
  layout: ui.Panel.Layout.flow('vertical'),
  style: {margin: '10px 0', padding: '10px', backgroundColor: '#e9ecef', borderRadius: '5px'}
});

var paramTitle = ui.Label({
  value: 'âš™ï¸ æ¨¡å‹å‚æ•°è®¾ç½®',
  style: {fontSize: '14px', fontWeight: 'bold', color: '#495057'}
});

// æ•°æ®æ¨¡ç³Šå¼€å…³
var blurCheckbox = ui.Checkbox({
  label: 'å¯ç”¨æ•°æ®æ¨¡ç³Šå¤„ç†',
  value: CONFIG.blur.enabled,
  style: {margin: '5px 0'}
});

// GPPå™ªå£°ç³»æ•°æ»‘å—
var gppNoiseSlider = ui.Slider({
  min: 0,
  max: 0.5,
  value: CONFIG.blur.gppNoiseFactor,
  step: 0.01,
  style: {width: '250px', margin: '5px 0'}
});
var gppNoiseLabel = ui.Label('GPPå™ªå£°ç³»æ•°: ' + CONFIG.blur.gppNoiseFactor);

// äº§é‡å™ªå£°ç³»æ•°æ»‘å—
var yieldNoiseSlider = ui.Slider({
  min: 0,
  max: 0.2,
  value: CONFIG.blur.yieldNoiseFactor,
  step: 0.005,
  style: {width: '250px', margin: '5px 0'}
});
var yieldNoiseLabel = ui.Label('äº§é‡å™ªå£°ç³»æ•°: ' + CONFIG.blur.yieldNoiseFactor);

// å¹´ä»½é€‰æ‹©
var yearSelect = ui.Select({
  items: ['2019', '2020', '2021', '2022'],
  value: '2022',
  placeholder: 'é€‰æ‹©åˆ†æå¹´ä»½',
  style: {width: '150px', margin: '5px 0'}
});

// åˆ†æåŒºåŸŸé€‰æ‹©  
var regionSelect = ui.Select({
  items: ['ç ”ç©¶åŒº1', 'ç ”ç©¶åŒº2', 'ç ”ç©¶åŒº3', 'å…¨åŒºåŸŸ'],
  value: 'å…¨åŒºåŸŸ',
  placeholder: 'é€‰æ‹©åˆ†æåŒºåŸŸ',
  style: {width: '150px', margin: '5px 0'}
});

// æ‰§è¡ŒæŒ‰é’®
var runButton = ui.Button({
  label: 'ğŸš€ å¼€å§‹åˆ†æ',
  style: {
    backgroundColor: '#28a745',
    color: 'white',
    fontWeight: 'bold',
    fontSize: '14px',
    margin: '15px 0 10px 0',
    width: '200px'
  }
});

var exportButton = ui.Button({
  label: 'ğŸ“¥ å¯¼å‡ºç»“æœ',
  style: {
    backgroundColor: '#007bff',
    color: 'white',
    fontWeight: 'bold',
    fontSize: '14px',
    margin: '5px 0',
    width: '200px'
  }
});

// çŠ¶æ€æ˜¾ç¤º
var statusLabel = ui.Label({
  value: 'ğŸ“Š çŠ¶æ€: å°±ç»ª',
  style: {
    fontSize: '12px',
    color: '#6c757d',
    margin: '10px 0'
  }
});

// è¿›åº¦æ¡
var progressBar = ui.Panel({
  style: {
    height: '20px',
    backgroundColor: '#e9ecef',
    border: '1px solid #ced4da',
    borderRadius: '10px',
    margin: '10px 0'
  }
});

// ============================= æ•°æ®æ¨¡ç³Šå‡½æ•° =====================================
/**
 * å¯¹å½±åƒæ·»åŠ éšæœºå™ªå£°è¿›è¡Œæ¨¡ç³Šå¤„ç†
 */
var addImageNoise = function(image, noiseFactor) {
  if (!CONFIG.blur.enabled) return image;
  
  var noise = ee.Image.random().subtract(0.5).multiply(noiseFactor * 2);
  var bounds = image.geometry();
  noise = noise.clip(bounds);
  
  return image.add(noise.multiply(image.abs().multiply(0.1)));
};

/**
 * å¯¹æ—¶é—´åºåˆ—è¿›è¡Œå¹³æ»‘å¤„ç†
 */
var temporalSmoothing = function(collection, windowSize) {
  if (!CONFIG.blur.enabled) return collection;
  
  var smoothed = collection.map(function(image) {
    var date = ee.Date(image.get('system:time_start'));
    var window = collection.filterDate(
      date.advance(-windowSize, 'day'),
      date.advance(windowSize, 'day')
    );
    return window.mean()
      .set('system:time_start', image.get('system:time_start'))
      .copyProperties(image, ['system:time_start']);
  });
  
  return smoothed;
};

// ============================= æ ¸å¿ƒå¤„ç†å‡½æ•° =====================================
/**
 * è·å–æ¨¡ç³Šå¤„ç†åçš„ä½œç‰©æ©è†œ
 */
var getCropMask = function() {
  // ä½¿ç”¨æ¨¡æ‹Ÿçš„ä½œç‰©åˆ†ç±»æ•°æ®
  var simulatedCropland = ee.Image.random().multiply(100).toInt()
    .remap([0, 20, 40, 60, 80, 100], [10, 20, 40, 50, 60, 70])
    .clip(ROI);
  
  var cropMask = simulatedCropland.eq(40); // å‡è®¾40ä¸ºä½œç‰©ç±»å‹
  if (CONFIG.blur.enabled) {
    // æ·»åŠ å½¢æ€å­¦æ“ä½œè¿›è¡Œæ¨¡ç³Š
    cropMask = cropMask.focal_mode(30, 'circle', 'meters');
  }
  
  return cropMask;
};

/**
 * æ¨¡ç³Šçš„GPPè®¡ç®—æ¨¡å—ï¼ˆæ›¿ä»£æ•æ„Ÿçš„çœŸå®ç®—æ³•ï¼‰
 */
var calculateBlurredGPP = function(startDate, endDate, params, region) {
  // ç”Ÿæˆæ¨¡æ‹Ÿçš„GPPæ—¶é—´åºåˆ—
  var dates = ee.List.sequence(0, 180, 5).map(function(day) {
    return ee.Date(startDate).advance(day, 'day');
  });
  
  var gppCollection = ee.ImageCollection.fromImages(
    dates.map(function(date) {
      var dayOfYear = ee.Date(date).getRelative('day', 'year');
      
      // æ¨¡æ‹Ÿå­£èŠ‚æ€§GPPå˜åŒ–ï¼ˆæ­£å¼¦æ³¢ + éšæœºå™ªå£°ï¼‰
      var seasonalGPP = ee.Image.constant(dayOfYear).divide(365)
        .multiply(2).multiply(Math.PI).sin()
        .add(1).multiply(params[0]).add(params[1]);
      
      // æ·»åŠ ç©ºé—´å˜å¼‚æ€§
      var spatialVariation = ee.Image.random().subtract(0.5).multiply(2);
      var gpp = seasonalGPP.add(spatialVariation).max(0);
      
      // æ•°æ®æ¨¡ç³Šå¤„ç†
      if (CONFIG.blur.enabled) {
        gpp = addImageNoise(gpp, CONFIG.blur.gppNoiseFactor);
        gpp = gpp.focal_mean(CONFIG.blur.spatialSmooth, 'circle', 'meters');
      }
      
      return gpp.rename('GPP')
        .set('system:time_start', ee.Date(date).millis())
        .set('doy', dayOfYear)
        .clip(region);
    })
  );
  
  return gppCollection;
};

/**
 * è°æ³¢åˆ†æå‡½æ•°ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
 */
var harmonicAnalysis = function(gppCollection) {
  statusLabel.setValue('ğŸ“ˆ æ­£åœ¨è¿›è¡Œè°æ³¢åˆ†æ...');
  
  var addHarmonics = function(image) {
    var timeRadians = ee.Image.constant(2).multiply(Math.PI)
      .multiply(image.date().getRelative('day', 'year')).divide(365);
    
    return image
      .addBands(timeRadians.cos().rename('cos'))
      .addBands(timeRadians.sin().rename('sin'))
      .addBands(ee.Image.constant(1).rename('constant'));
  };
  
  var harmonicCollection = gppCollection.map(addHarmonics);
  
  var harmonicTrend = harmonicCollection
    .select(['constant', 'cos', 'sin', 'GPP'])
    .reduce(ee.Reducer.linearRegression(3, 1));
  
  var coefficients = harmonicTrend.select('coefficients')
    .arrayProject([0])
    .arrayFlatten([['constant', 'cos', 'sin']]);
  
  var fittedCollection = harmonicCollection.map(function(image) {
    var fitted = image.select(['constant', 'cos', 'sin'])
      .multiply(coefficients)
      .reduce('sum');
    return image.addBands(fitted.rename('fitted'));
  });
  
  return {
    collection: fittedCollection,
    coefficients: coefficients
  };
};

/**
 * äº§é‡é¢„æµ‹å‡½æ•°
 */
var predictYield = function(gppResult, coeffs) {
  statusLabel.setValue('ğŸŒ¾ æ­£åœ¨é¢„æµ‹äº§é‡...');
  
  // è®¡ç®—ç´¯ç§¯GPP
  var cumulativeGPP = gppResult.collection.select('fitted').sum();
  
  // æ•°æ®æ¨¡ç³Šå¤„ç†
  if (CONFIG.blur.enabled) {
    cumulativeGPP = addImageNoise(cumulativeGPP, CONFIG.blur.yieldNoiseFactor);
  }
  
  // åº”ç”¨æ¨¡ç³Šçš„äº§é‡æ¨¡å‹
  var yield = cumulativeGPP
    .multiply(CONFIG.model.yieldCoeff[0])
    .add(CONFIG.model.yieldCoeff[1]);
  
  return yield.max(0).rename('predicted_yield');
};

// ============================= ä¸»å¤„ç†æµç¨‹ =====================================
var mainAnalysis = function() {
  try {
    statusLabel.setValue('ğŸ”„ å¼€å§‹å¤„ç†...');
    updateProgress(20);
    
    var selectedYear = yearSelect.getValue();
    var startDate = selectedYear + '-01-01';
    var endDate = (parseInt(selectedYear) + 1) + '-01-01';
    
    // è·å–ä½œç‰©æ©è†œ
    var cropMask = getCropMask();
    updateProgress(40);
    
    // è®¡ç®—æ¨¡ç³ŠGPP
    var gppParams = selectedYear === '2022' ? 
      CONFIG.model.gppParams2022 : CONFIG.model.gppParams2021;
    var gppCollection = calculateBlurredGPP(startDate, endDate, gppParams, ROI);
    updateProgress(60);
    
    // è°æ³¢åˆ†æ
    var harmonicResult = harmonicAnalysis(gppCollection);
    updateProgress(80);
    
    // äº§é‡é¢„æµ‹
    var predictedYield = predictYield(harmonicResult, harmonicResult.coefficients);
    updateProgress(100);
    
    // åº”ç”¨ä½œç‰©æ©è†œ
    var maskedYield = predictedYield.updateMask(cropMask);
    
    // å¯è§†åŒ–å‚æ•°
    var yieldVis = {
      min: 3,
      max: 12,
      palette: ['#d73027', '#f46d43', '#fdae61', '#fee08b', '#e6f598', 
                '#abdda4', '#66c2a5', '#3288bd', '#5e4fa2']
    };
    
    var gppVis = {
      min: 0,
      max: 50,
      palette: ['#ffffff', '#f7fcb9', '#d9f0a3', '#addd8e', '#78c679',
                '#41ab5d', '#238443', '#005a32']
    };
    
    // æ·»åŠ å›¾å±‚åˆ°åœ°å›¾
    Map.layers().reset();
    Map.addLayer(ROI, {color: 'black', fillColor: '00000000'}, 'ç ”ç©¶åŒºè¾¹ç•Œ');
    Map.addLayer(maskedYield, yieldVis, 'é¢„æµ‹äº§é‡ (t/ha)');
    Map.addLayer(harmonicResult.collection.select('fitted').max(), gppVis, 'æœ€å¤§GPP');
    Map.addLayer(cropMask.selfMask(), {palette: ['green']}, 'ä½œç‰©åŒºåŸŸ');
    Map.addLayer(AOI, {color: 'red', pointSize: 8}, 'ç ”ç©¶ç‚¹');
    
    // è®¾ç½®åœ°å›¾ä¸­å¿ƒ
    Map.centerObject(ROI, 10);
    
    statusLabel.setValue('âœ… åˆ†æå®Œæˆï¼');
    
    // å­˜å‚¨ç»“æœç”¨äºå¯¼å‡º
    window.analysisResults = {
      yield: maskedYield,
      gpp: harmonicResult.collection.select('fitted').max(),
      region: ROI,
      year: selectedYear
    };
    
  } catch (error) {
    statusLabel.setValue('âŒ é”™è¯¯: ' + error.message);
    print('åˆ†æé”™è¯¯:', error);
  }
};

// ============================= è¾…åŠ©å‡½æ•° =====================================
var updateProgress = function(percentage) {
  progressBar.clear();
  var filled = ui.Panel({
    style: {
      width: percentage + '%',
      height: '18px',
      backgroundColor: '#28a745',
      borderRadius: '9px',
      margin: '1px'
    }
  });
  progressBar.add(filled);
};

var exportResults = function() {
  if (!window.analysisResults) {
    statusLabel.setValue('âŒ è¯·å…ˆè¿è¡Œåˆ†æ');
    return;
  }
  
  try {
    var results = window.analysisResults;
    
    // å¯¼å‡ºäº§é‡é¢„æµ‹ç»“æœ
    Export.image.toDrive({
      image: results.yield.multiply(100).toUint16(),
      description: 'Yield_Prediction_' + results.year,
      folder: 'GPP_Yield_Analysis',
      region: results.region,
      scale: 30,
      maxPixels: 1e13,
      crs: 'EPSG:4326'
    });
    
    // å¯¼å‡ºç‚¹æ•°æ®
    var pointData = results.yield.reduceRegions({
      collection: datapt,
      reducer: ee.Reducer.mean(),
      scale: 30,
      crs: 'EPSG:4326'
    });
    
    Export.table.toDrive({
      collection: pointData,
      description: 'Point_Yield_Data_' + results.year,
      folder: 'GPP_Yield_Analysis',
      fileFormat: 'CSV'
    });
    
    statusLabel.setValue('ğŸ“¤ å¯¼å‡ºä»»åŠ¡å·²æäº¤');
    
  } catch (error) {
    statusLabel.setValue('âŒ å¯¼å‡ºé”™è¯¯: ' + error.message);
  }
};

// ============================= äº‹ä»¶å¤„ç† =====================================
// æ»‘å—å€¼å˜åŒ–äº‹ä»¶
gppNoiseSlider.onChange(function(value) {
  CONFIG.blur.gppNoiseFactor = value;
  gppNoiseLabel.setValue('GPPå™ªå£°ç³»æ•°: ' + value.toFixed(3));
});

yieldNoiseSlider.onChange(function(value) {
  CONFIG.blur.yieldNoiseFactor = value;
  yieldNoiseLabel.setValue('äº§é‡å™ªå£°ç³»æ•°: ' + value.toFixed(3));
});

// æ¨¡ç³Šå¼€å…³äº‹ä»¶
blurCheckbox.onChange(function(checked) {
  CONFIG.blur.enabled = checked;
  statusLabel.setValue(checked ? 'ğŸ”€ æ•°æ®æ¨¡ç³Šå·²å¯ç”¨' : 'ğŸ”’ æ•°æ®æ¨¡ç³Šå·²ç¦ç”¨');
});

// æŒ‰é’®ç‚¹å‡»äº‹ä»¶
runButton.onClick(mainAnalysis);
exportButton.onClick(exportResults);

// ============================= ç•Œé¢ç»„è£… =====================================
controlPanel.add(title);
controlPanel.add(ui.Label('é€‰æ‹©åˆ†æå‚æ•°:', {fontWeight: 'bold', margin: '10px 0 5px 0'}));
controlPanel.add(ui.Panel([ui.Label('å¹´ä»½:', {width: '60px'}), yearSelect], ui.Panel.Layout.flow('horizontal')));
controlPanel.add(ui.Panel([ui.Label('åŒºåŸŸ:', {width: '60px'}), regionSelect], ui.Panel.Layout.flow('horizontal')));

parameterSection.add(paramTitle);
parameterSection.add(blurCheckbox);
parameterSection.add(ui.Panel([ui.Label('GPPå™ªå£°:', {width: '80px'}), gppNoiseSlider], ui.Panel.Layout.flow('horizontal')));
parameterSection.add(gppNoiseLabel);
parameterSection.add(ui.Panel([ui.Label('äº§é‡å™ªå£°:', {width: '80px'}), yieldNoiseSlider], ui.Panel.Layout.flow('horizontal')));
parameterSection.add(yieldNoiseLabel);

controlPanel.add(parameterSection);
controlPanel.add(ui.Panel([runButton, exportButton], ui.Panel.Layout.flow('horizontal')));
controlPanel.add(statusLabel);
controlPanel.add(progressBar);

// æ·»åŠ å¸®åŠ©ä¿¡æ¯
var helpPanel = ui.Panel({
  layout: ui.Panel.Layout.flow('vertical'),
  style: {margin: '20px 0', padding: '10px', backgroundColor: '#f8f9fa', borderRadius: '5px'}
});

helpPanel.add(ui.Label('ğŸ“– ä½¿ç”¨è¯´æ˜:', {fontWeight: 'bold', fontSize: '12px'}));
helpPanel.add(ui.Label('1. é€‰æ‹©åˆ†æå¹´ä»½å’ŒåŒºåŸŸ', {fontSize: '11px', margin: '2px 0'}));
helpPanel.add(ui.Label('2. è°ƒæ•´æ•°æ®æ¨¡ç³Šå‚æ•°', {fontSize: '11px', margin: '2px 0'}));
helpPanel.add(ui.Label('3. ç‚¹å‡»"å¼€å§‹åˆ†æ"è¿è¡Œæ¨¡å‹', {fontSize: '11px', margin: '2px 0'}));
helpPanel.add(ui.Label('4. åˆ†æå®Œæˆåå¯å¯¼å‡ºç»“æœ', {fontSize: '11px', margin: '2px 0'}));

controlPanel.add(helpPanel);

// ============================= åˆå§‹åŒ–ç•Œé¢ =====================================
// æ¸…ç©ºåŸæœ‰ç•Œé¢å¹¶æ·»åŠ æ–°ç•Œé¢
ui.root.clear();
ui.root.add(controlPanel);

// è®¾ç½®åœ°å›¾é€‰é¡¹
Map.setOptions('SATELLITE');
Map.centerObject(AOI, 12);
Map.addLayer(ROI, {color: 'red', fillColor: '00000000'}, 'ç ”ç©¶åŒºè¾¹ç•Œ');
Map.addLayer(AOI, {color: 'yellow', pointSize: 10}, 'ç ”ç©¶ä¸­å¿ƒç‚¹');

// åˆå§‹çŠ¶æ€
statusLabel.setValue('ğŸ¯ ç•Œé¢å·²åŠ è½½ï¼Œè¯·é…ç½®å‚æ•°åå¼€å§‹åˆ†æ');
updateProgress(0);

// ============================= æ·»åŠ å›¾ä¾‹ =====================================
var createLegend = function() {
  var legend = ui.Panel({
    style: {
      position: 'bottom-left',
      padding: '8px 15px',
      backgroundColor: 'rgba(255,255,255,0.9)',
      borderRadius: '5px'
    }
  });
  
  var legendTitle = ui.Label({
    value: 'å›¾ä¾‹',
    style: {fontWeight: 'bold', fontSize: '14px', margin: '0 0 5px 0'}
  });
  
  legend.add(legendTitle);
  legend.add(ui.Label('ğŸŸ¢ ä½œç‰©åŒºåŸŸ', {fontSize: '12px', margin: '2px 0'}));
  legend.add(ui.Label('ğŸ”´ ç ”ç©¶è¾¹ç•Œ', {fontSize: '12px', margin: '2px 0'}));
  legend.add(ui.Label('ğŸŸ¡ ç ”ç©¶ä¸­å¿ƒ', {fontSize: '12px', margin: '2px 0'}));
  
  return legend;
};

// åœ¨åœ°å›¾ä¸Šæ·»åŠ å›¾ä¾‹
Map.add(createLegend());

print('ğŸš€ GPP-äº§é‡é¢„æµ‹åˆ†æå·¥å…·å·²å¯åŠ¨');
print('ğŸ”§ ç‰ˆæœ¬ç‰¹è‰²: æ•°æ®éšç§ä¿æŠ¤ã€äº¤äº’å¼ç•Œé¢ã€æ¨¡ç³Šå¤„ç†ç®—æ³•');
print('ğŸ’¡ æç¤º: ä½¿ç”¨å·¦ä¾§æ§åˆ¶é¢æ¿è¿›è¡Œåˆ†æå‚æ•°é…ç½®');